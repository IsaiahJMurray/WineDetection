<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wine Classifier</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #0f0f15;
      --bg-tertiary: #151520;
      --border: #1a1a25;
      --border-light: #252530;
      --text-primary: #e8e8f0;
      --text-secondary: #a0a0b0;
      --text-tertiary: #606070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-glow: rgba(99, 102, 241, 0.15);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      overflow-x: hidden;
    }
    
    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 24px;
      position: relative;
      z-index: 1;
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: 48px;
      animation: fadeInDown 0.6s ease-out;
    }
    
    .header h1 {
      font-size: 36px;
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 400;
    }
    
    /* Main content grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    
    @media (min-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr 1fr;
      }
      .input-card {
        grid-column: 0;
      }
      .results-card {
        grid-column: 1;
      }
    }
    
    /* Cards */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      border-color: var(--border-light);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .card:hover::before {
      opacity: 0;
    }
    
    /* Input card */
    .input-card {
      grid-column: 0;
    }
    
    @media (min-width: 900px) {
      .input-card {
        grid-column: none;
      }
      .results-card {
        grid-column: none;
        width: 100%;
      }
    }
    
    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    /* Textarea */
    textarea {
      width: 100%;
      min-height: 160px;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: all 0.2s ease;
    }
    
    textarea::placeholder {
      color: var(--text-tertiary);
    }
    
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
      background: var(--bg-secondary);
    }
    
    /* Request button */
    .request-btn {
      margin-top: 16px;
      padding: 12px 24px;
      background: var(--gradient);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: none;
      align-self: flex-start;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .request-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }
    
    .request-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .request-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Queue notice */
    .queue-notice {
      margin-top: 12px;
      padding: 12px 16px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 10px;
      color: var(--warning);
      font-size: 13px;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    /* Results card */
    .results-card {
      min-height: 300px;
      grid-column: 1;
    }
    
    .results-placeholder {
      color: var(--text-tertiary);
      font-size: 14px;
      text-align: center;
      padding: 60px 20px;
    }
    
    /* Prediction bars */
    .bars {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .bar-row {
      display: grid;
      grid-template-columns: 140px 1fr 70px;
      gap: 16px;
      align-items: center;
      opacity: 0;
      transform: translateX(-20px);
      animation: slideInBar 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .bar-row:nth-child(1) { animation-delay: 0.05s; }
    .bar-row:nth-child(2) { animation-delay: 0.1s; }
    .bar-row:nth-child(3) { animation-delay: 0.15s; }
    .bar-row:nth-child(4) { animation-delay: 0.2s; }
    .bar-row:nth-child(5) { animation-delay: 0.25s; }
    .bar-row:nth-child(n+6) { animation-delay: 0.3s; }
    
    @keyframes slideInBar {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .bar-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0;
      animation: fadeInText 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .bar-row:nth-child(1) .bar-label { animation-delay: 0.1s; }
    .bar-row:nth-child(2) .bar-label { animation-delay: 0.15s; }
    .bar-row:nth-child(3) .bar-label { animation-delay: 0.2s; }
    .bar-row:nth-child(4) .bar-label { animation-delay: 0.25s; }
    .bar-row:nth-child(5) .bar-label { animation-delay: 0.3s; }
    .bar-row:nth-child(n+6) .bar-label { animation-delay: 0.35s; }
    
    @keyframes fadeInText {
      to {
        opacity: 1;
      }
    }
    
    .bar-track {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }
    
    .bar-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 999px;
      width: 0%;
      box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
      position: relative;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      animation: shimmer 3s infinite;
      pointer-events: none;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .bar-pct {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: right;
      font-variant-numeric: tabular-nums;
      opacity: 0;
      transform: translateX(10px);
      animation: slideInPct 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .bar-row:nth-child(1) .bar-pct { animation-delay: 0.2s; }
    .bar-row:nth-child(2) .bar-pct { animation-delay: 0.25s; }
    .bar-row:nth-child(3) .bar-pct { animation-delay: 0.3s; }
    .bar-row:nth-child(4) .bar-pct { animation-delay: 0.35s; }
    .bar-row:nth-child(5) .bar-pct { animation-delay: 0.4s; }
    .bar-row:nth-child(n+6) .bar-pct { animation-delay: 0.45s; }
    
    @keyframes slideInPct {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Status indicator */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 16px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
      animation: pulse 2s infinite;
    }
    
    .status-dot.ok {
      background: var(--success);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }
    
    .status-dot.bad {
      background: var(--error);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }
    
    /* Advanced settings */
    .advanced-toggle {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }
    
    .advanced-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color 0.2s ease;
    }
    
    .advanced-btn:hover {
      color: var(--accent);
    }
    
    .advanced-btn::after {
      content: '▼';
      font-size: 10px;
      transition: transform 0.3s ease;
    }
    
    .advanced-btn.expanded::after {
      transform: rotate(180deg);
    }
    
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 0;
    }
    
    .advanced-panel.visible {
      max-height: 1000px;
      opacity: 1;
      margin-top: 20px;
    }
    
    .advanced-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .advanced-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .advanced-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .advanced-input {
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: all 0.2s ease;
    }
    
    .advanced-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    
    .advanced-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-secondary {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-secondary);
      border-color: var(--border-light);
    }
    
    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .stats-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .stat-item {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }
    
    /* Examples panel */
    .examples-panel {
      margin-top: 20px;
      display: none;
    }
    
    .examples-panel.visible {
      display: block;
    }
    
    .examples-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
    }
    
    select {
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    select:hover {
      border-color: var(--border-light);
    }
    
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }
    
    /* Animations */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* Meta info */
    .meta {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-tertiary);
    }
    
    code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--accent);
      font-family: 'Monaco', 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Wine Classifier</h1>
      <p>Enter a wine tasting note to predict the variety</p>
    </div>

    <div class="main-grid">
      <div class="card results-card">
        <div class="card-title">Predictions</div>
        <div class="bars" id="bars">
          <div class="results-placeholder">Enter a tasting note to see predictions</div>
        </div>
      </div>
      <div class="card input-card">
        <div class="card-title">Tasting Note</div>
        <textarea id="text" placeholder="e.g., black cherry, leather, cedar, firm tannins, smoky finish..."></textarea>
        
        <div id="queueModeNotice" class="queue-notice">
          ⚠️ Rate limited: Real-time updates disabled. Use the button below to queue requests.
        </div>
        
        <button id="requestBtn" class="request-btn">Request Prediction</button>
        
        <div class="status-indicator">
          <span id="dot" class="status-dot"></span>
          <span id="statusText">Connecting...</span>
        </div>
        
        <div class="meta" id="meta"></div>
        
        <!-- Advanced Settings -->
        <div class="advanced-toggle">
          <button id="advancedToggle" class="advanced-btn">Advanced Settings</button>
          <div id="advancedPanel" class="advanced-panel">
            <div class="advanced-section">
              <div class="advanced-row">
                <label class="advanced-label">API Endpoint</label>
                <input id="apiUrl" type="text" class="advanced-input" value="https://ectal-unbelievingly-shella.ngrok-free.dev/predict" />
              </div>
              
              <div class="advanced-row">
                <label class="advanced-label">Live Update Speed (ms)</label>
                <input id="debounceDelay" type="number" class="advanced-input" value="150" min="50" max="1000" step="50" />
                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
                  Lower = faster updates (50-1000ms)
                </div>
              </div>
              
              <div class="advanced-buttons">
                <button id="pingBtn" class="btn-secondary">Test Connection</button>
                <button id="loadExamplesBtn" class="btn-secondary">Load Examples</button>
              </div>
              
              <div id="examplesPanel" class="examples-panel">
                <div class="examples-grid">
                  <select id="categorySelect"></select>
                  <select id="exampleSelect"></select>
                </div>
              </div>
              
              <div class="stats-row">
                <div class="stat-item">Client ID: <span class="stat-value" id="clientIdEl">-</span></div>
                <div class="stat-item">Tokens: <span class="stat-value" id="tokensEl">-</span></div>
                <div class="stat-item">Queue: <span class="stat-value" id="queueEl">-</span></div>
                <div class="stat-item">Users (1h): <span class="stat-value" id="usersHourEl">-</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Debounce helper ---
    let debounceTimer = null;
    function debounce(fn) {
      return (...args) => {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fn(...args), debounceDelay);
      };
    }
    
    function cancelDebounced() {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
        debounceTimer = null;
      }
    }

    // Elements
    const textEl = document.getElementById("text");
    const barsEl = document.getElementById("bars");
    const apiUrlEl = document.getElementById("apiUrl");
    const metaEl = document.getElementById("meta");
    const statusText = document.getElementById("statusText");
    const dot = document.getElementById("dot");
    const pingBtn = document.getElementById("pingBtn");
    const loadExamplesBtn = document.getElementById("loadExamplesBtn");
    const examplesPanel = document.getElementById("examplesPanel");
    const categorySelect = document.getElementById("categorySelect");
    const exampleSelect = document.getElementById("exampleSelect");
    const clientIdEl = document.getElementById("clientIdEl");
    const tokensEl = document.getElementById("tokensEl");
    const queueEl = document.getElementById("queueEl");
    const usersHourEl = document.getElementById("usersHourEl");
    const requestBtn = document.getElementById("requestBtn");
    const queueModeNotice = document.getElementById("queueModeNotice");
    const advancedToggle = document.getElementById("advancedToggle");
    const advancedPanel = document.getElementById("advancedPanel");
    const debounceDelayEl = document.getElementById("debounceDelay");
    
    // Track real-time mode state
    let realtimeEnabled = true;
    let pendingRequest = false;
    let advancedVisible = false;
    let debounceDelay = 150; // Default faster speed
    
    // Load saved debounce delay
    const savedDelay = localStorage.getItem('qea_debounce_delay');
    if (savedDelay) {
      debounceDelay = parseInt(savedDelay);
      if (debounceDelayEl) {
        debounceDelayEl.value = debounceDelay;
      }
    }
    
    // Update debounce delay when input changes
    if (debounceDelayEl) {
      debounceDelayEl.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        if (value >= 50 && value <= 1000) {
          debounceDelay = value;
          localStorage.setItem('qea_debounce_delay', value);
          // Recreate debounced function with new delay
          predictDebounced = debounce(predictNow);
        }
      });
    }

    // Advanced settings toggle
    advancedToggle.addEventListener('click', () => {
      advancedVisible = !advancedVisible;
      advancedToggle.classList.toggle('expanded', advancedVisible);
      advancedPanel.classList.toggle('visible', advancedVisible);
    });

    function setStatus(ok, msg) {
      statusText.textContent = msg;
      dot.className = "status-dot " + (ok ? "ok" : "bad");
    }

    // --- client id stored in localStorage ---
    let clientId = localStorage.getItem('qea_client_id');
    if (!clientId) {
      if (window.crypto && crypto.randomUUID) clientId = crypto.randomUUID();
      else clientId = 'c-' + Math.random().toString(36).slice(2,12);
      localStorage.setItem('qea_client_id', clientId);
    }
    clientIdEl.textContent = clientId.substring(0, 8) + '...';

    // --- small fetch helper with retries for transient HTML interstitials ---
    async function fetchJsonWithRetry(url, opts = {}, retries = 2, backoff = 300) {
      let lastErr = null;
      for (let attempt = 0; attempt <= retries; attempt++) {
        try {
          const res = await fetch(url, opts);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const ct = res.headers.get('content-type') || '';
          if (ct.indexOf('application/json') === -1) {
            const txt = await res.text();
            throw new Error('non-json:' + txt.slice(0,200));
          }
          return await res.json();
        } catch (e) {
          lastErr = e;
          if (attempt < retries) await new Promise(r => setTimeout(r, backoff * (attempt + 1)));
        }
      }
      throw lastErr;
    }

    function renderBars(predictions) {
      const entries = Object.entries(predictions).sort((a,b) => b[1] - a[1]);
      barsEl.innerHTML = "";
      
      for (const [label, pct] of entries) {
        const row = document.createElement("div");
        row.className = "bar-row";

        const labelEl = document.createElement("div");
        labelEl.className = "bar-label";
        labelEl.textContent = label;

        const track = document.createElement("div");
        track.className = "bar-track";

        const fill = document.createElement("div");
        fill.className = "bar-fill";
        const finalWidth = Math.max(0, Math.min(100, pct));
        // Start at 0, then animate to target width
        fill.style.width = '0%';
        // Use requestAnimationFrame to ensure DOM is ready, then animate
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            fill.style.width = finalWidth + '%';
          });
        });

        track.appendChild(fill);

        const pctEl = document.createElement("div");
        pctEl.className = "bar-pct";
        // Animate percentage count-up
        let currentPct = 0;
        const targetPct = pct;
        const duration = 800;
        const startTime = Date.now();
        
        function animatePct() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          // Easing function
          const eased = progress < 0.5 
            ? 2 * progress * progress 
            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
          currentPct = targetPct * eased;
          pctEl.textContent = currentPct.toFixed(1) + "%";
          
          if (progress < 1) {
            requestAnimationFrame(animatePct);
          } else {
            pctEl.textContent = targetPct.toFixed(1) + "%";
          }
        }
        animatePct();

        row.appendChild(labelEl);
        row.appendChild(track);
        row.appendChild(pctEl);
        barsEl.appendChild(row);
      }
    }

    async function predictNow() {
      if (pendingRequest) return;
      
      const apiUrl = apiUrlEl.value.trim();
      const text = textEl.value.trim();

      if (!text) {
        barsEl.innerHTML = "<div class='results-placeholder'>Enter text to see predictions.</div>";
        metaEl.textContent = "";
        return;
      }

      pendingRequest = true;
      requestBtn.disabled = true;
      if (!realtimeEnabled) {
        setStatus(false, "Waiting in queue...");
        requestBtn.textContent = "Processing...";
      }

      const t0 = performance.now();
      try {
        const res = await fetch(apiUrl, { 
          method: "POST", 
          headers: { 
            "Content-Type": "application/json", 
            "Accept": "application/json", 
            "x-client-id": clientId 
          }, 
          body: JSON.stringify({ text }) 
        });
        
        if (!res.ok) {
          const ct = res.headers.get('content-type') || '';
          let errorMsg = `HTTP ${res.status}`;
          if (ct.indexOf('application/json') !== -1) {
            try {
              const errData = await res.json();
              errorMsg = errData.detail || errorMsg;
            } catch (e) {}
          }
          
          if (res.status === 429) {
            setStatus(false, "Rate limited");
            metaEl.textContent = `Rate limit: ${errorMsg}`;
            cancelDebounced();
            realtimeEnabled = false;
            updateRealtimeMode();
            setTimeout(() => fetchStatus(), 500);
          } else if (res.status === 413) {
            setStatus(false, "Request too long");
            metaEl.textContent = `Request too long: ${errorMsg}`;
          } else {
            setStatus(false, `Error ${res.status}`);
            metaEl.textContent = errorMsg;
          }
          return;
        }
        
        const ct = res.headers.get('content-type') || '';
        if (ct.indexOf('application/json') === -1) {
          const txt = await res.text();
          throw new Error('non-json:' + txt.slice(0,200));
        }
        
        const data = await res.json();
        const dt = (performance.now() - t0).toFixed(0);

        setStatus(true, `Connected (${dt}ms)`);
        metaEl.textContent = `Device: ${data.device ?? "unknown"} • ${dt}ms`;

        renderBars(data.predictions || {});
        setTimeout(() => fetchStatus(), 500);
      } catch (e) {
        setStatus(false, "Error");
        metaEl.textContent = String(e).slice(0,200);
        console.error('predictNow error', e);
      } finally {
        pendingRequest = false;
        requestBtn.disabled = false;
        requestBtn.textContent = "Request Prediction";
      }
    }
    
    let predictDebounced = debounce(predictNow);

    textEl.addEventListener("input", () => {
      if (realtimeEnabled && !pendingRequest) {
        predictDebounced();
      }
    });
    
    requestBtn.addEventListener("click", async () => {
      await predictNow();
    });

    pingBtn.addEventListener("click", async () => {
      const prev = textEl.value;
      if (!prev.trim()) textEl.value = "black cherry, oak, tannins";
      await predictNow();
      if (!prev.trim()) textEl.value = "";
    });

    function examplesBaseUrl() {
      const api = apiUrlEl.value.trim();
      return api.replace(/\/predict\/?$/i, "").replace(/\/$/, "");
    }

    async function loadExamples() {
      const base = examplesBaseUrl();
      const url = base + "/api/examples";
      try {
        const data = await fetchJsonWithRetry(url, { 
          method: "POST", 
          headers: { "Content-Type": "text/plain", "Accept": "application/json" }, 
          body: clientId 
        }, 2, 300);

        categorySelect.innerHTML = "";
        for (const k of Object.keys(data)) {
          const opt = document.createElement('option');
          opt.value = k;
          opt.textContent = k;
          categorySelect.appendChild(opt);
        }

        if (categorySelect.options.length > 0) {
          categorySelect.selectedIndex = 0;
          populateExamplesFor(categorySelect.value, data);
        }

        examplesPanel.classList.add('visible');
        setStatus(true, "Examples loaded");
      } catch (e) {
        setStatus(false, "Examples load failed");
        console.error(e);
        metaEl.textContent = String(e).slice(0,200);
      }
    }

    function populateExamplesFor(category, data) {
      const arr = data[category] || [];
      exampleSelect.innerHTML = "";
      for (const ex of arr) {
        const o = document.createElement('option');
        o.value = ex;
        o.textContent = ex.length > 80 ? ex.slice(0, 80) + '...' : ex;
        exampleSelect.appendChild(o);
      }
    }

    loadExamplesBtn.addEventListener('click', async () => {
      await loadExamples();
    });

    categorySelect.addEventListener('change', async () => {
      const base = examplesBaseUrl();
      const url = base + "/api/examples";
      try {
        const data = await fetchJsonWithRetry(url, { 
          method: "POST", 
          headers: { "Content-Type": "text/plain", "Accept": "application/json" }, 
          body: clientId 
        }, 2, 300);
        populateExamplesFor(categorySelect.value, data);
      } catch (e) { console.error(e); }
    });

    function updateRealtimeMode() {
      const tokens = parseInt(tokensEl.textContent) || 0;
      const queueLen = parseInt(queueEl.textContent) || 0;
      const shouldEnable = tokens > 0 && queueLen === 0;
      
      if (shouldEnable !== realtimeEnabled) {
        realtimeEnabled = shouldEnable;
        
        if (realtimeEnabled) {
          requestBtn.style.display = 'none';
          queueModeNotice.style.display = 'none';
          if (textEl.value.trim() && !pendingRequest) {
            predictDebounced();
          }
        } else {
          cancelDebounced();
          requestBtn.style.display = 'block';
          queueModeNotice.style.display = 'block';
        }
      }
    }
    
    async function fetchStatus() {
      const base = examplesBaseUrl();
      const url = base + "/api/status";
      try {
        const data = await fetchJsonWithRetry(url, { 
          method: "POST", 
          headers: { "Content-Type": "text/plain", "Accept": "application/json" }, 
          body: clientId 
        }, 2, 300);
        tokensEl.textContent = data.tokens;
        queueEl.textContent = data.queue_len;
        usersHourEl.textContent = data.users_past_hour;
        updateRealtimeMode();
      } catch (e) {
        console.error('fetchStatus failed', e);
        tokensEl.textContent = 'ERR';
        queueEl.textContent = '-';
      }
    }

    fetchStatus().then(() => {
      updateRealtimeMode();
    });
    setInterval(fetchStatus, 5000);

    exampleSelect.addEventListener('change', () => {
      const v = exampleSelect.value || '';
      if (v) {
        textEl.value = v;
        if (realtimeEnabled && !pendingRequest) {
          predictDebounced();
        } else {
          predictNow();
        }
      }
    });
  </script>
</body>
</html>
